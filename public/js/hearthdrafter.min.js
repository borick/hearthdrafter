var selected=[null,null,null],userList=null,dat={},img="/images/cards_medium/",img_small="/images/cards_small/",card_back="/images/card_selection_back.png",rarity="none",number_element,old_index=0,selected_index=0,selected_card=0,name_to_id=[],mode="start",d=new Date,arena_id="unknown",pathArray=window.location.pathname.split("/",-1),arena_id=pathArray[3];function createElement(a,b,e){var f=$("<div/>");f.attr({id:b});f.css(e);a.append(f);return f}
function createInputButton(a,b,e,f,g,h){div=$("<div/>");div.attr({id:f,"class":f});div.html();div.css(b);a.prepend(div);a=$('<a href="#">'+e+"</a>").prependTo(div);a.click({id:g,name:f},h);return a}$(document).keydown(function(a){switch(a.which){case 13:for(z=0;3>z;z++)if(null==selected[z]){showClassCards(z);break}}});
function rebindKeys(){$(".search").off("keydown");$(".search").keydown(function(a){switch(a.which){case 38:old_index=selected_index;--selected_index;0>selected_index&&(selected_index=0);highlightElement(selected_index);break;case 40:old_index=selected_index;selected_index+=1;selected_index>=getCurrentListLength()-1&&(selected_index=getCurrentListLength()-1);highlightElement(selected_index);break;case 13:$("li div").get(selected_index).click();break;default:old_index=selected_index,selected_index=
0,highlightElement(selected_index)}})}function resetBG(a){$(".card"+(a+1)).css({"background-image":"url("+card_back+")"})}function initCardClick(a){var b=$(".card"+(a+1));b.click(function(){showClassCards(a)});b.html("");resetBG(a)}function initCardClicks(){for(var a=0;3>a;a++)initCardClick(a)}
function loadCardSelection(){card_selected=0;initCardClicks();rebindKeys();$(".search").hide();number_element=createElement($("#top_bar"),"card_number",{});updateNumber(card_number);cancel_link=createElement($("#top_bar"),"undo_last_card",{});cancel_link.html('<a href="#" onclick="undoLastCard(); return false;">Undo last card</a>');$(document).click(function(a){$(".search").focus();rebindKeys()});$(document).keydown(function(a){8!==a.which||$(a.target).is("input, textarea")||a.preventDefault()})}
function confirmCards(){mode="waiting_for_card";selected_card=0;old_index=selected_index;selected_index=0;var a="/draft/card_choice/"+selected[0]+"/"+selected[1]+"/"+selected[2]+"/"+arena_id,b=b||[];b.push(["_trackPageview",a]);$.get(a,function(a){loadChosenCards(a)})}function changeBg(a){a=getCardElement(a);a.css({background:"rgba(0,0,0,.75)"});return a}
function showClassCards(a){old_index=selected_index;selected_index=0;selected_card=a;for(var b=0;3>b;b++)a!=b&&null==selected[b]&&resetBG(b);var b=changeBg(a),e=$("#cards");e.css({display:"block","z-index":9999});e.addClass("capital");b.append(e);rebuildList();$(".search").focus();highlightElement(selected_index);b=$(".name").button();$(".list li").mousemove(function(a){name=$(this).text();old_index=selected_index});b.click(function(b){b.preventDefault();b.stopPropagation();b=$(this);card_picked(a,
b.text())})}function card_picked(a,b){$("#cards").css({display:"none"});layoutCardChosen(b,a);userList.clear();$(".search").hide();$("body").append($("#cards"));var e=0;for(z=0;3>z;z++)if(null==selected[z]){e=z;break}0==e&&confirmCards()}function setMessageText(a,b){return $('<p id="top_message_'+a+'">'+b+"</p>")}function updateNumber(a){$("#card_number").text(a+"/30")}
function highlightElement(a){var b=$("#cards");4<a&&b.scrollTop(35*(a-5));$("li div:eq("+old_index+")").removeClass("ui-state-hover");$("li div:eq("+a+")").addClass("ui-state-hover")}function getCurrentListLength(){return $("li div").length}
function filterList(){if("none"!=rarity){var a=[];for(i=0;i<userList.items.length;i++){var b=userList.items[i],e=b._values,f=1;"unknown"!=rarity&&("basic"==rarity||"free"==rarity||"common"==rarity?"basic"!=e.rarity&&"free"!=e.rarity&&"common"!=e.rarity&&(f=0):e.rarity!=rarity&&(f=0));for(j=0;j<selected.length;j++)null!=selected[j]&&e.name==selected[j]&&(f=0);f&&a.push(b)}userList.items=a}}
function rebuildList(){null!=userList&&userList.clear();userList=new List("cards",{valueNames:["name"],item:'<li><div class="name"></div></li>'},cards);userList.on("searchComplete",function(){highlightElement(selected_index)});filterList();userList.page=1E3;userList.sort("name");$(".search").val("");$(".search").show().focus();rebindKeys()}function removeUndo(){removeElement("#undo")}function removeElement(a){for(;$(a).length;)for(var b=0;b<$(a).length;b++)$(a).remove()}
function removeConfirmChoices(){removeElement("#ipicked")}function removeHighlight(){$("div#highlight").hide()}function removeSynergies(){for(s=0;3>s;s++)$("#outer-synergies"+s).remove()}function makeOdometer(a){a=$('<div class="odometer card_'+(a+1)+'_meter">0</div>');od=new Odometer({el:a.get(0),value:0,format:"",theme:"minimal"});return a}function updateOdometer(a,b){var e=$(".card_"+(a+1)+"_meter");e.show();e.text(0);e.text(parseInt(b))}
function removeOdo(){$("#odo").remove();$("#odo").remove();$("#odo").remove()}function getCardElement(a){return $(".card"+(a+1))}
function undoCardChoice(a){removeHighlight();removeConfirmChoices();getCardElement(a);selected[a]=null;null==selected[0]&&null==selected[1]&&null==selected[2]&&(rarity="none");removeElement("#best");removeElement(".waiting");$("#message_panel").hide();initCardClick(a);removeOdo();removeSynergies();null!=selected[0]&&addWaiting(0);null!=selected[1]&&addWaiting(1);null!=selected[2]&&addWaiting(2)}function getCardFile(a){return img+card_ids[a]+".png"}
function addWaiting(a){a=getCardElement(a);var b=$('<div class="waiting"/>');b.text("Waiting for all cards to be picked...");b.appendTo(a);b.addClass(class_name)}
function layoutCardChosen(a,b){"undefined"===typeof card_data[a]&&(alert("Class Mismatch! "+class_name+' does not have the card "'+a+'"'),document.location.href="/home");var e=getCardElement(b);e.off("click");selected[b]=a;rarity=card_rarity[a];var f=$('<div id="card_img_'+b+'"/>');f.css({"background-image":'url("'+getCardFile(a)+'")'});f.appendTo(e);f.addClass("type_"+card_data[a].type);f.addClass(class_name);f=$('<div class="card_name_label"/>');f.text(a);f.appendTo(e);f.addClass("capital");f.addClass(class_name);
addWaiting(b);createInputButton(e,{},'<img src="/images/cancel.png"/>',"undo",b,function(a){$(this).remove();undoCardChoice(b);a.stopPropagation()});return e}function loadChosenCards(a){console.log(a);$(".waiting").remove();buildConfirmChoices(arena_id);buildScoreUI(a);buildSynergyUI(a);$("#message_panel").text(a.message);$("#message_panel").show();$("#message_panel").addClass(class_name)}
function buildConfirmChoices(a){for(j=0;j<selected.length;j++)createInputButton($(".card"+(j+1)),{},"I Picked This Card","ipicked",j,function(a){confirmCardChoice(a)}).addClass(class_name)}
function buildScoreUI(a){for(c=0;3>c;c++){var b=$('<span id="odo"></span>');b.appendTo(getCardElement(c));makeOdometer(c).hide().appendTo(b);if(selected[c]==a.best_card){getCardElement(c).find("#best").remove();var e=$('<span class="gold" id="best">Yes!</span>');e.appendTo(getCardElement(c));b.addClass("best_score")}else e=$('<span class="bronze" id="best">No</span>'),e.appendTo(getCardElement(c))}b=-100;for(j=0;j<selected.length;j++)name_to_id[selected[j]]=j,e=a.scores[selected[j]],e>b&&(b=e),updateOdometer(j,
e)}function confirmCardByName(a,b){for(i=0;i<selected.length;i++)if(selected[i]==a){confirmCard(i,b);break}}function finishConfirm(a){card_number+=1;30<=card_number?($('[class^="card"]').hide(),document.location.href="/draft/results/"+arena_id):(updateChosenCardsTab(a),removeConfirmChoices(),updateNumber(card_number),initCardClicks(),selected=[],rarity="none",removeUndo(),removeHighlight(),$("#message_panel").hide())}
function undoLastCard(){if(window.confirm("Are you sure you want to undo the last card choice? There is no redo.")){var a="/draft/arena_action/undo_last_card_"+arena_id,b=b||[];b.push(["_trackPageview",a]);$.get(a,function(a){0!=card_number&&(--card_number,removeConfirmChoices(),removeElement(".waiting"),updateNumber(card_number),initCardClicks(),selected=[],removeUndo(),removeHighlight(),updateChosenCardsTab(a),updateUndoLink())})}}
function confirmCard(a,b){if(b)finishConfirm(b);else{var e="/draft/confirm_card_choice/"+selected[a]+"/"+arena_id,f=f||[];f.push(["_trackPageview",e]);$.get(e,function(a){finishConfirm(a);updateUndoLink()})}}function confirmCardChoice(a){a.preventDefault();a.stopPropagation();confirmCard(a.data.id)}
function updateChosenCardsTab(a){var b=Object.keys(a),e,f=b.length;b.sort();$("#cards_chosen").html("");for(e=0;e<f;e++){k=b[e];var g=$('<tr><td id="card_name"><span class="capital">'+k+'</span></td><td id="card_count">'+a[k]+"</td></tr>");$("#cards_chosen").append(g)}updateManaCostChosenCards()}function updateUndoLink(){0<card_number?$("#undo_last_card").show():$("#undo_last_card").hide()}
function createSynergiesDiv(a){var b=$('<div id="synergies'+a+'" class="synergy_list">');a=$('<div class="outer-syn" id="outer-synergies'+a+'"><h3>Synergies</h3></div>');b.appendTo(a);return a}
function buildSynergyUI(a,b){for(myvar in a.synergy){synergies=createSynergiesDiv(name_to_id[myvar]);var e=0;for(syn in a.synergy[myvar]){var f=a.synergy[myvar][syn].card_name,e=a.synergy[myvar][syn].reason,g=$('<div class="item"></div>');g.appendTo(synergies.find('[id^="synergies"]'));f=$('<a href="#">'+f+"</a>");f.appendTo(g);f.prop("title",e);f.addClass("capital");e=1}e||$("<p><i>None found.</i>").appendTo(synergies.find('[id^="synergies"]'));card_pane=$(".card"+(name_to_id[myvar]+1));synergies.appendTo(card_pane)}}
;
